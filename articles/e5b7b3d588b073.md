---
title: "Visual Studio Codeã®Dev Containersã§Ralisã®é–‹ç™ºç’°å¢ƒã‚’ä½œã‚‹"
emoji: "ğŸ’"
type: "tech"
topics:
  - "rails"
  - "vscode"
  - "debug"
  - "devcontainer"
published: true
published_at: "2023-08-22 15:10"
---

Ruby on Railsï¼ˆRailsï¼‰ã®é–‹ç™ºã‚’ã™ã‚‹ã®ã«ã€Visual Studio Codeï¼ˆVSCodeï¼‰ã®Dev Containersã‚’ä½¿ã£ã¦ã€ã‚³ãƒ³ãƒ†ãƒŠä¸Šã«é–‹ç™ºç’°å¢ƒã‚’ä½œã£ã¦ã€ãã“ã§é–‹ç™ºã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã¾ã¨ã‚ã‚‹ã€‚

## ã‚„ã‚‹ã“ã¨

- Railsã¨PostgreSQLã®2ã¤ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’Dev Containersã§ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
- Ralisã¨rspecã®ãƒ‡ãƒãƒƒã‚°ã‚’ã€ãƒ‡ãƒãƒƒã‚¬ãƒ¼ã‚’ä½¿ã£ã¦ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
- ã‚³ãƒ³ãƒ†ãƒŠå†…ã§diff-highlightã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹

## å‰ææ¡ä»¶

ä¸‹è¨˜ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã¯ã™ã§ã«å°å…¥æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ã€‚

- Visual Studio Code
- Docker for Desktop ã¾ãŸã¯ OrbStack

### ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³

è¨˜äº‹ã‚’æ›¸ã„ãŸã¨ãã«åˆ©ç”¨ã—ã¦ã„ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ä¸‹è¨˜ã®é€šã‚Šã€‚

- macOS 13.5.1
- Visual Studio Code 1.81.1
- OrbStack 0.16.1

## è¨­å®šæ‰‹é †

### VSCodeã«æ‹¡å¼µã‚’å…¥ã‚Œã‚‹

VSCodeã«ã€Dev Containersã®æ‹¡å¼µã‚’å°å…¥ã™ã‚‹ã€‚

- [Dev Containers - Visual Studio Marketplace](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers)

### Dev Containerã®æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹

ã‚³ãƒ³ãƒ†ãƒŠã®ä½œæˆæ–¹æ³•ã¯ã€å¤§ããåˆ†ã‘ã¦2ã¤ã‚ã‚‹ã€‚

- ã‚³ãƒ³ãƒ†ãƒŠã§å®Ÿè¡Œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ†ãƒŠå†…ã«ç›´æ¥å±•é–‹ã™ã‚‹
- ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚³ãƒ³ãƒ†ãƒŠã«ãƒã‚¦ãƒ³ãƒˆã™ã‚‹

å‰è€…ã ã¨ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤ã™ã‚‹ã¨ã‚³ãƒ¼ãƒ‰ã‚‚æ¶ˆãˆã¦ã—ã¾ã†[^1]ã®ã§ã€è‡ªåˆ†ã¯å¾Œè€…ã®æ‰‹æ³•ã‚’å–ã‚‹ã€‚

[^1]: è©¦ã—ã¦ãªã„ãŒã€ä»•çµ„ã¿ã‚’è€ƒãˆã‚‹ã¨ãã†ãªã‚‹ã¯ãšã€‚

ã¾ãšã€ä»»æ„ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’VSCodeã§é–‹ãã€ãã®çŠ¶æ…‹ã§ä¸‹è¨˜ã®æ‰‹é †ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

- ã‚³ãƒãƒ³ãƒ‰ãƒ‘ãƒ¬ãƒƒãƒˆã‚’é–‹ã`é–‹ç™ºã‚³ãƒ³ãƒ†ãƒŠãƒ¼æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ...`ã‚’å®Ÿè¡Œã™ã‚‹
- `ã™ã¹ã¦ã®å®šç¾©ã‚’è¡¨ç¤º...`ã‚’å®Ÿè¡Œã™ã‚‹
- `rails`ã¨å…¥åŠ›ã™ã‚‹ã¨ã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ`Ruby on Rails & Postgres`ãŒå‡ºã¦ãã‚‹ã®ã§ã€ãã‚Œã‚’é¸æŠã™ã‚‹
- Rubyã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã§ãã‚‹ã®ã§ã€ä½¿ã„ãŸã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹
	- Apple Siliconã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯ã€`-bookworm`ã¾ãŸã¯`-bullseye`ã‚’ä½¿ã†ã“ã¨[^2]
- è¿½åŠ æ©Ÿèƒ½ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã„å ´åˆã¯é¸æŠã™ã‚‹ï¼ˆä»»æ„ï¼‰
	- å€‹äººçš„ã«ã¯ã€vimã¨ã‹fishã‚’å…¥ã‚Œã¦ã„ã‚‹

[^2]: [templates/src/ruby-rails-postgres at main Â· devcontainers/templates](https://github.com/devcontainers/templates/tree/main/src/ruby-rails-postgres)ã®ã€README.mdã«ã€`Ruby version (use -bookworm, -bullseye variants on local arm64/Apple Silicon)`ã¨è¨˜è¼‰ãŒã‚ã‚‹

å®Œäº†ã™ã‚‹ã¨ã€`.devcontainer`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œæˆã•ã‚Œã€ãã®ä¸­ã«ã„ãã¤ã‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã‚‹

### ã‚³ãƒ³ãƒ†ãƒŠã‚’æ§‹æˆã™ã‚‹

ã‚³ãƒ³ãƒ†ãƒŠãŒä½œæˆã•ã‚ŒãŸå¾Œã«å®Ÿè¡Œã—ãŸã„ã‚³ãƒãƒ³ãƒ‰ãŒã„ãã¤ã‹ã‚ã‚‹ã®ã§ã€ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¦ã€ãã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

#### ã‚³ãƒ³ãƒ†ãƒŠä½œæˆæ™‚ã«å®Ÿè¡Œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è¨­å®š

`.devcontainer`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã€`postCreateCommand.sh`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚ä¸­èº«ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ã™ã‚‹ã€‚

```sh:.devcontainer/postCreateCommand.sh
#!/bin/sh

# bundle installã®ã‚¨ãƒ©ãƒ¼å¯¾ç­–
sudo chown -R vscode /usr/local/rvm/gems/default
bundle install

# diff-highlightã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
cd /usr/share/doc/git/contrib/diff-highlight && sudo make
mkdir -p ~/.local/bin
ln -s /usr/share/doc/git/contrib/diff-highlight/diff-highlight ~/.local/bin/diff-highlight
```

##### bundle installã®ã‚¨ãƒ©ãƒ¼å¯¾ç­–

`bundle install`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`/usr/local/rvm/gems/default/cache/`ã«gemãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã¦å±•é–‹ã—ã‚ˆã†ã¨ã—ã¦ã€`PermissionError`ãŒå‡ºã¦ã—ã¾ã†ã€‚ãã®å¯¾ç­–ã¨ã—ã¦ã€Dev Containersã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚ã‚‹`vscode`ã‚’ownerã«ã—ã¦æ›¸ãè¾¼ã‚ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹[^3]ã€‚

#### diff-highlightã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹

gitã«ä»˜å±ã—ã¦ã„ã‚‹diff-highlightã‚³ãƒãƒ³ãƒ‰ãŒä½¿ã„ãŸã‹ã£ãŸã®ã§ã€ä½¿ã†ãŸã‚ã®æ§‹æˆã‚’ã—ã¦ã„ã‚‹ã€‚Dev Containerã§ã¯ã€`~/.local/bin`ã«ãƒ‘ã‚¹ãŒé€šã£ã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã«ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ä½œæˆã—ã¦ã„ã‚‹ã€‚

[^3]: ã“ã®å¯¾ç­–ãŒè‰¯ã„ã¨ã¯æ€ã£ã¦ãªã„ã€‚ã¨ã¯ã„ãˆã€ã©ã†ã™ã‚‹ã®ãŒã‚ˆã‚Šè‰¯ã„è§£æ±ºç­–ãªã®ã‹èª¿ã¹ã¦ã‚‚ã‚ˆãåˆ†ã‹ã‚‰ãªã‹ã£ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã®é–‹ç™ºç’°å¢ƒã§ã‚ã‚‹ã“ã¨ãŒå‰æãªã®ã§ç›®ã‚’ç‘ã£ã¦ã„ã‚‹ã€‚

### VSCodeã®æ‹¡å¼µã‚’å…¥ã‚Œã‚‹

VSCodeã®æ‹¡å¼µã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ã¾ãŸã¯ãƒªãƒ¢ãƒ¼ãƒˆã§å‹•ãã‚ˆã†ãªè¨­è¨ˆã«ãªã£ã¦ã„ã‚‹[^4]ã¨ã„ã†ã“ã¨ã§ã€ã‚³ãƒ³ãƒ†ãƒŠã«ãƒªãƒ¢ãƒ¼ãƒˆæ¥ç¶šã™ã‚‹ã¨ã€å…ƒã€…ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¦ã‚‚ä½¿ãˆãªã„æ‹¡å¼µãŒã‚ã‚‹ã€‚ãã‚Œã‚‰ã‚’è‡ªå‹•çš„ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚ˆã†ã«æ§‹æˆã—ãŸã„ã€‚

[^4]: "Extensions are typically designed and tested to either run locally or remotely, not both." - [Developing inside a Container using Visual Studio Code Remote Development](https://code.visualstudio.com/docs/devcontainers/containers#_advanced-forcing-an-extension-to-run-locally-or-remotely)

ä»Šå›ã¯ã€Rubyã‚’ãƒ‡ãƒãƒƒã‚°ã™ã‚‹ãŸã‚ã®æ‹¡å¼µã‚’å…¥ã‚Œã‚‹ãŸã‚ã«ã€ä¸‹è¨˜ã®ã‚ˆã†ãªè¨­å®šã‚’è¿½åŠ ã™ã‚‹ã€‚

```json:.devcontainer/devcontainer.json
{
	// ...
 	"customizations": {
 		"vscode": {
 			"extensions": [
 				"KoichiSasada.vscode-rdbg"
 			]
 		}
 	}
}
```

ã‚³ãƒ³ãƒ†ãƒŠã¨ã€ãã‚Œã«ä»˜éšã—ãŸVSCodeã®æ§‹æˆã¯ä»¥ä¸Šã¨ãªã‚‹ã€‚

### Railsã¨rspecã®ãƒ‡ãƒãƒƒã‚°ã®è¨­å®š

VSCodeã§Railsã‚„rspecã‚’ãƒ‡ãƒãƒƒã‚°ã™ã‚‹ãŸã‚ã®è¨­å®šã‚’ã™ã‚‹ã€‚ã“ã‚Œã¯å½“ç„¶ãªãŒã‚‰Dev Containerç’°å¢ƒã§ãªãã¦ã‚‚åˆ©ç”¨ã§ãã‚‹ã€‚

- `.vscode`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã™ã‚‹
- `.vscode/launch.json`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä¸‹è¨˜ã®ã‚ˆã†ãªå†…å®¹ã«ã™ã‚‹ã€‚

```json:.vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "rdbg",
      "name": "Run rails server",
      "rdbgPath": "bundle exec rdbg", // Use the debug.gem described in the Gemfile
      "request": "launch",
      "command": "bin/rails", // Breakpoints do not work with "rails".
      "script": "s", // launch rails server with debugger
      "args": [],
      "askParameters": false // Do not ask startup parameter any more
    },
    {
      "type": "rdbg",
      "name": "Debug Rspec with current file",
      "rdbgPath": "bundle exec rdbg",
      "request": "launch",
      "command": "rspec",
      "script": "${file}",
      "args": [],
      "askParameters": true // Confirm the executed command in the window. Make it easy to specify options such as execution of 
    }
  ]
}
```

Railsã®ãƒ‡ãƒãƒƒã‚°ã‚’ã™ã‚‹å ´åˆã¯ã€`Run rails server`ã‚’å®Ÿè¡Œã™ã‚‹ã€‚ã‚³ãƒ¼ãƒ‰ã«ãƒ–ãƒ¬ã‚¤ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’å…¥ã‚Œã‚‹ã¨ã€ãã“ã§åœæ­¢ã—ã¦å¤‰æ•°ã‚’ç¢ºèªã—ãŸã‚Šã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

rspecã®ãƒ‡ãƒãƒƒã‚°ã‚’ã™ã‚‹å ´åˆã¯ã€`Debug Rspec with current file`ã‚’å®Ÿè¡Œã™ã‚‹ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ã‚¨ãƒ‡ã‚£ã‚¿ã§é–‹ã„ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ãŒæŒ‡å®šã•ã‚Œã‚‹ã®ã§ã€ãƒ‡ãƒãƒƒã‚°ã—ãŸã„specãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ãŸçŠ¶æ…‹ã§å®Ÿè¡Œã™ã‚‹ã¨è‰¯ã„ã€‚

## ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã™ã‚‹

ã“ã“ã¾ã§ã§ããŸã‚‰ã€ã‚³ãƒãƒ³ãƒ‰ãƒ‘ãƒ¬ãƒƒãƒˆã‹ã‚‰`é–‹ç™ºã‚³ãƒ³ãƒ†ãƒŠãƒ¼: ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã§å†åº¦é–‹ãï¼ˆDev Containers: Reopen in Containerï¼‰`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ãŒä½œæˆã•ã‚Œã€ä½œæˆã—ãŸã‚³ãƒ³ãƒ†ãƒŠã«ãƒªãƒ¢ãƒ¼ãƒˆæ¥ç¶šã—ãŸçŠ¶æ…‹ã«ãªã‚‹ã€‚

## å‚è€ƒæƒ…å ±

- [Get started with development Containers in Visual Studio Code](https://code.visualstudio.com/docs/devcontainers/tutorial)
- [How to debug Rails running on Ruby 3.1 using VSCode and Dev Containers - DEV Community](https://dev.to/konyu/how-to-debug-rails-running-on-ruby-31-using-vscode-and-dev-containers-166l)