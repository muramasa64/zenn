{
  "title": "Amazon Cognitoのサインインに使えるユーザー属性の設定とその挙動について",
  "closed": false,
  "archived": false,
  "created_at": "2024-01-25",
  "comments": [
    {
      "author": "muramasa64",
      "created_at": "2024-01-25",
      "body_markdown": "# Amazon Cognitoはサインインに使える識別子の選択肢がある\n\nAWS Management Consoleから作成しようとすると「Cognito ユーザープールのサインインオプション」として、いくつかの選択肢が出てくる。\n\n![Cognito ユーザープールのサインインオプション](https://storage.googleapis.com/zenn-user-upload/ce9d699a85d5-20240125.png)\n\nこれは、ユーザープールを作成する際に設定し、途中で変更できない。このスクリーンショットでは、「ユーザー名」のみ選択した状態になっている。この場合にのみ「ユーザー名の要件」のオプションが表示される。\n\n実は、チェックする選択肢の数によっても異なる挙動になる、らしいので、どうなるのかを検証してみたい。\n\n\n",
      "body_updated_at": "2024-01-25"
    },
    {
      "author": "muramasa64",
      "created_at": "2024-01-25",
      "body_markdown": "# サインインオプションのドキュメント\n\nこれらの選択肢の意味や、選択した時の挙動などについて書かれたドキュメントは、下記のページになる。度ドキュメントの目次で言うと、ユーザーの管理 -> 属性となるので、場所が分かりづらい。\n\nhttps://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/user-pool-settings-attributes.html#user-pool-settings-aliases\n\n"
    },
    {
      "author": "muramasa64",
      "created_at": "2024-01-25",
      "body_markdown": "# ユーザー名として使える属性\n\nCognitoでは、サインインに利用可能な属性として「ユーザー名属性」と「エイリアス属性」の2種類の属性を定義している。\n\nユーザー名属性とエイリアス属性の違いは、ドキュメントに下記のように整理されている。\n\n- ユーザーが複数の属性を使ってサインアップまたはサインイン可能にするには、エイリアス属性を使う\n  - メールアドレス（email）、電話番号（phone_number）、優先ユーザー名（preferred_username）\n- エイリアス属性にemailとphone_numberを使う場合は、ユーザーはそれらを所有していることを確認する必要がある\n  - サインアップする際に、メールまたは電話に対して確認コードが送られてくる方式\n - エイリアス属性にemailとphone_numberを使う場合は、サインアップ時には他のユーザーが同じ値を使っていたとしても、エラーにはならない\n   - つまり、エイリアス属性の場合、同じemailまたはphone_numberを登録することができる\n - エイリアス属性は登録後に変更できる\n\nつまり、ユーザー名属性の場合は、エイリアス属性と違って、下記のような特徴がある。\n\n- ユーザー名属性以外の属性値でサインインできない\n- 重複した値を登録することができない（サインアップできない）\n- サインインするのに、emailやphone_numberの所有権の確認は不要\n- ユーザー名属性がemailとphone_numberの両方が有効になっている場合、サインインに使う識別子をemailからphone_numberに変更できない\n  - emailやphone_number自体を変更することはできる\n\nこれをみても、何をどうしたらどうなるのかが、よくわからないので、実際に試してみることにする。\n",
      "body_updated_at": "2024-01-25"
    },
    {
      "author": "muramasa64",
      "created_at": "2024-01-25",
      "body_markdown": "# ユーザープールを作成するAPIはどうなっているのか\n\nAWS Management Consoleでユーザープールを作成しようとすると、何をどう選択するとどうなるのかがとても分かりづらいので、APIの仕様を調べてみる。この場合、AWS CLIのドキュメントがわかりやすい。\n\nhttps://docs.aws.amazon.com/cli/latest/reference/cognito-idp/create-user-pool.html\n\n関連するオプションは`--username-attributes`と`--alias-attributes`である。\n\n## `--username-attributes`\n\n説明には、下記のように書いてある。\n\n> Specifies whether a user can use an email address or phone number as a username when they sign up.\n\nつまり、ユーザーを作成する際に、ユーザー名としてemailまたはphone_numberのどちらかを使う設定ということになる。有効な値は、emailまたはphone_numberとある。つまり、ユーザー名属性にはpreferred_usernameは使えない、ということだ。\n\nAWS Management Consoleでは、ユーザー名のみを指定することができたので、これは直感に反する。それについては一旦脇においておく。\n\n## `--alias-attributes`\n\n説明には、下記のように書いてある。\n\n> Attributes supported as an alias for this user pool. Possible values: phone_number , email , or preferred_username .\n\nphone_numberとemailとpreferred_usernameが使える、と書いてある。\n\nAWS Management Consoleでの指定は、こちらの方のような気がする。"
    },
    {
      "author": "muramasa64",
      "created_at": "2024-01-25",
      "body_markdown": "# AWS CLIでユーザープールを作成してみる\n\nでは、実際にAWS CLIを使ってユーザープールを作成してみることにする。とりあえず全部入りにしたらどうなるか。\n\n```sh\naws cognito-idp create-user-pool --pool-name usernametest --username-attributes email --alias-attributes phone_number preferred_username\n```\n\nしかしこれは、エラーになる。\n\n```\nAn error occurred (InvalidParameterException) when calling the CreateUserPool operation: Only one of the aliasAttributes or usernameAttributes can be set in a User pool.\n```\n\nつまり、`--username-attributes`と`--alias-attributes`は同時に指定できない。なるほど。\n\nでは、気を取り直して、ユーザー名属性だけにしてみよう。\n\n```sh\naws cognito-idp create-user-pool --pool-name usernametest --username-attributes email\n```\n\n結果が返された。\n\n```json\n{\n    \"UserPool\": {\n        \"Id\": \"us-west-2_xxxxxxxxxxx\",\n        \"Name\": \"usernametest\",\n        \"Policies\": {\n            \"PasswordPolicy\": {\n                \"MinimumLength\": 8,\n                \"RequireUppercase\": true,\n                \"RequireLowercase\": true,\n                \"RequireNumbers\": true,\n                \"RequireSymbols\": true,\n                \"TemporaryPasswordValidityDays\": 7\n            }\n        },\n        \"DeletionProtection\": \"INACTIVE\",\n        \"LambdaConfig\": {},\n        \"LastModifiedDate\": \"2024-01-25T13:38:33.287000+09:00\",\n        \"CreationDate\": \"2024-01-25T13:38:33.287000+09:00\",\n        \"SchemaAttributes\": [\n            {\n                \"Name\": \"sub\",\n                \"AttributeDataType\": \"String\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": false,\n                \"Required\": true,\n                \"StringAttributeConstraints\": {\n                    \"MinLength\": \"1\",\n                    \"MaxLength\": \"2048\"\n                }\n            },\n            {\n                \"Name\": \"name\",\n                \"AttributeDataType\": \"String\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": true,\n                \"Required\": false,\n                \"StringAttributeConstraints\": {\n                    \"MinLength\": \"0\",\n                    \"MaxLength\": \"2048\"\n                }\n            },\n            {\n                \"Name\": \"given_name\",\n                \"AttributeDataType\": \"String\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": true,\n                \"Required\": false,\n                \"StringAttributeConstraints\": {\n                    \"MinLength\": \"0\",\n                    \"MaxLength\": \"2048\"\n                }\n            },\n            {\n                \"Name\": \"family_name\",\n                \"AttributeDataType\": \"String\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": true,\n                \"Required\": false,\n                \"StringAttributeConstraints\": {\n                    \"MinLength\": \"0\",\n                    \"MaxLength\": \"2048\"\n                }\n            },\n            {\n                \"Name\": \"middle_name\",\n                \"AttributeDataType\": \"String\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": true,\n                \"Required\": false,\n                \"StringAttributeConstraints\": {\n                    \"MinLength\": \"0\",\n                    \"MaxLength\": \"2048\"\n                }\n            },\n            {\n                \"Name\": \"nickname\",\n                \"AttributeDataType\": \"String\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": true,\n                \"Required\": false,\n                \"StringAttributeConstraints\": {\n                    \"MinLength\": \"0\",\n                    \"MaxLength\": \"2048\"\n                }\n            },\n            {\n                \"Name\": \"preferred_username\",\n                \"AttributeDataType\": \"String\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": true,\n                \"Required\": false,\n                \"StringAttributeConstraints\": {\n                    \"MinLength\": \"0\",\n                    \"MaxLength\": \"2048\"\n                }\n            },\n            {\n                \"Name\": \"profile\",\n                \"AttributeDataType\": \"String\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": true,\n                \"Required\": false,\n                \"StringAttributeConstraints\": {\n                    \"MinLength\": \"0\",\n                    \"MaxLength\": \"2048\"\n                }\n            },\n            {\n                \"Name\": \"picture\",\n                \"AttributeDataType\": \"String\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": true,\n                \"Required\": false,\n                \"StringAttributeConstraints\": {\n                    \"MinLength\": \"0\",\n                    \"MaxLength\": \"2048\"\n                }\n            },\n            {\n                \"Name\": \"website\",\n                \"AttributeDataType\": \"String\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": true,\n                \"Required\": false,\n                \"StringAttributeConstraints\": {\n                    \"MinLength\": \"0\",\n                    \"MaxLength\": \"2048\"\n                }\n            },\n            {\n                \"Name\": \"email\",\n                \"AttributeDataType\": \"String\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": true,\n                \"Required\": false,\n                \"StringAttributeConstraints\": {\n                    \"MinLength\": \"0\",\n                    \"MaxLength\": \"2048\"\n                }\n            },\n            {\n                \"Name\": \"email_verified\",\n                \"AttributeDataType\": \"Boolean\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": true,\n                \"Required\": false\n            },\n            {\n                \"Name\": \"gender\",\n                \"AttributeDataType\": \"String\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": true,\n                \"Required\": false,\n                \"StringAttributeConstraints\": {\n                    \"MinLength\": \"0\",\n                    \"MaxLength\": \"2048\"\n                }\n            },\n            {\n                \"Name\": \"birthdate\",\n                \"AttributeDataType\": \"String\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": true,\n                \"Required\": false,\n                \"StringAttributeConstraints\": {\n                    \"MinLength\": \"10\",\n                    \"MaxLength\": \"10\"\n                }\n            },\n            {\n                \"Name\": \"zoneinfo\",\n                \"AttributeDataType\": \"String\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": true,\n                \"Required\": false,\n                \"StringAttributeConstraints\": {\n                    \"MinLength\": \"0\",\n                    \"MaxLength\": \"2048\"\n                }\n            },\n            {\n                \"Name\": \"locale\",\n                \"AttributeDataType\": \"String\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": true,\n                \"Required\": false,\n                \"StringAttributeConstraints\": {\n                    \"MinLength\": \"0\",\n                    \"MaxLength\": \"2048\"\n                }\n            },\n            {\n                \"Name\": \"phone_number\",\n                \"AttributeDataType\": \"String\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": true,\n                \"Required\": false,\n                \"StringAttributeConstraints\": {\n                    \"MinLength\": \"0\",\n                    \"MaxLength\": \"2048\"\n                }\n            },\n            {\n                \"Name\": \"phone_number_verified\",\n                \"AttributeDataType\": \"Boolean\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": true,\n                \"Required\": false\n            },\n            {\n                \"Name\": \"address\",\n                \"AttributeDataType\": \"String\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": true,\n                \"Required\": false,\n                \"StringAttributeConstraints\": {\n                    \"MinLength\": \"0\",\n                    \"MaxLength\": \"2048\"\n                }\n            },\n            {\n                \"Name\": \"updated_at\",\n                \"AttributeDataType\": \"Number\",\n                \"DeveloperOnlyAttribute\": false,\n                \"Mutable\": true,\n                \"Required\": false,\n                \"NumberAttributeConstraints\": {\n                    \"MinValue\": \"0\"\n                }\n            }\n        ],\n        \"UsernameAttributes\": [\n            \"email\"\n        ],\n        \"VerificationMessageTemplate\": {\n            \"DefaultEmailOption\": \"CONFIRM_WITH_CODE\"\n        },\n        \"UserAttributeUpdateSettings\": {\n            \"AttributesRequireVerificationBeforeUpdate\": []\n        },\n        \"MfaConfiguration\": \"OFF\",\n        \"EstimatedNumberOfUsers\": 0,\n        \"EmailConfiguration\": {\n            \"EmailSendingAccount\": \"COGNITO_DEFAULT\"\n        },\n        \"AdminCreateUserConfig\": {\n            \"AllowAdminCreateUserOnly\": false,\n            \"UnusedAccountValidityDays\": 7\n        },\n        \"Arn\": \"arn:aws:cognito-idp:us-west-2:966281585925:userpool/us-west-2_ocZLX8XJd\",\n        \"AccountRecoverySetting\": {\n            \"RecoveryMechanisms\": [\n                {\n                    \"Priority\": 1,\n                    \"Name\": \"verified_email\"\n                },\n                {\n                    \"Priority\": 2,\n                    \"Name\": \"verified_phone_number\"\n                }\n            ]\n        }\n    }\n}\n```\n\nUsernameAttributesがemailになっている。他に気になる点としては、email属性がMutable: trueになっていることだ。ユーザー名をメールアドレスにしても、email属性とは関係ないらしい。\n"
    },
    {
      "author": "muramasa64",
      "created_at": "2024-01-25",
      "body_markdown": "\n# ユーザーを作成してみる\n\nでは、ユーザーを作成してみる。あえてユーザー名をメールアドレスではないものにしてみる。\n\n```sh\naws cognito-idp admin-create-user --user-pool-id $USER_POOL_ID --username foo\n```\n\n当然エラーになる。\n\n```\nAn error occurred (InvalidParameterException) when calling the AdminCreateUser operation: Username should be an email.\n```\n\nちゃんと作成してみる。\n\n```sh\naws cognito-idp admin-create-user --user-pool-id $USER_POOL_ID --username foo@example.com\n\n結果が返ってきた。\n\n```json\n{\n    \"User\": {\n        \"Username\": \"990e8246-8f3b-489d-83fa-665da23bf781\",\n        \"Attributes\": [\n            {\n                \"Name\": \"sub\",\n                \"Value\": \"990e8246-8f3b-489d-83fa-665da23bf781\"\n            },\n            {\n                \"Name\": \"email\",\n                \"Value\": \"foo@example.com\"\n            }\n        ],\n        \"UserCreateDate\": \"2024-01-25T13:42:46.263000+09:00\",\n        \"UserLastModifiedDate\": \"2024-01-25T13:42:46.263000+09:00\",\n        \"Enabled\": true,\n        \"UserStatus\": \"FORCE_CHANGE_PASSWORD\"\n    }\n}\n```\n\nどうやら、Username属性はメールアドレスではなく、自動生成されたUUIDになるらしい。"
    },
    {
      "author": "muramasa64",
      "created_at": "2024-01-25",
      "body_markdown": "# 見えてきたこと\n\nここまでで見えてきたこと。\n\n- ユーザープール作成時のパラメータとして、ユーザー名属性とエイリアス属性は排他的である\n  - つまり、ユーザープールの設定として、ユーザーの認証方式としてユーザー名属性を使うか、エイリアス属性を使うか、どちらかを選択する必要がある\n- ユーザーを作成したときに、`--username`のパラメータとして渡した値が、`User.Username`になるわけではない\n  - 内部的にはUUIDが自動生成されて割り振られる。こと値は変更できない。\n "
    },
    {
      "author": "muramasa64",
      "created_at": "2024-01-25",
      "body_markdown": "# Usernameの扱われ方\n\nAWS CLIを使ってユーザーを操作する際には、`--username`を指定する。例えば、ユーザーの情報を取得する場合はこうなる。\n\n```sh\naws cognito-idp admin-get-user --user-pool-id $USER_POOL_ID --username foo@example.com\n```\n\nメールアドレスがユーザー名属性と指定されているので、メールアドレスを使うことができる。一方で、内部的なusernameとして発行されたUUIDを使うこともできる。\n\n```sh\naws cognito-idp admin-get-user --user-pool-id $USER_POOL_ID --username 990e8246-8f3b-489d-83fa-665da23bf781\n```\n\nこれは、どちらも同じ結果を返す。このことから、ユーザープールはユーザー名属性として設定された属性値を、ユーザー名としてみなす、という挙動になっているということがわかる。\n\nユーザー名属性がemailの場合に、下記のようにメールアドレスを変更できる。\n\n```sh\n❯ aws cognito-idp admin-update-user-attributes --user-pool-id $USER_POOL_ID --username foo@example.com --user-attributes \"Name=email,Value=bar@example.com\"\n```\n\nそして、もちろん、情報を取得する場合は、変更後のメールアドレスが使える。"
    },
    {
      "author": "muramasa64",
      "created_at": "2024-01-25",
      "body_markdown": "# エイリアス属性を使ったユーザープール\n\nエイリアス属性を使ったユーザープールを作成する。\n\n```sh\n❯ aws cognito-idp create-user-pool --pool-name usernametest --alias-attributes email phone_number preferred_username\n```"
    }
  ]
}