{
  "title": "Amazon Cognitoのユーザー属性",
  "closed": true,
  "archived": false,
  "created_at": "2023-12-15",
  "comments": [
    {
      "author": "muramasa64",
      "created_at": "2023-12-15",
      "body_markdown": "Amazon Cognitoのユーザー属性について整理する\nhttps://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/user-pool-settings-attributes.html"
    },
    {
      "author": "muramasa64",
      "created_at": "2023-12-15",
      "body_markdown": "# 属性の種類\n\n* OIDCの仕様の基づいた標準属性（Standard Attributes）と、カスタム属性（Custom Attributes）がある。\n* 属性値は、標準とカスタムの両方とも、最大で2048文字（2048 characters）まで入れることができる。\n* 値は任意だが、一部の属性はフォーマットに制限がある\n  * birthdate: YYYY-MM-DD\n  * email: Eメールアドレスの形式\n  * phone_number: `+`から始まる数字のみ。ハイフンなどは使えない\n ",
      "body_updated_at": "2023-12-15"
    },
    {
      "author": "muramasa64",
      "created_at": "2023-12-15",
      "body_markdown": "# ユーザー識別子として使える属性\n\n* 属性に関わる設定として、ユーザープールを作成する際に「ユーザープールのサインインオプション」の設定をすることができる。これは、ユーザープールの作成時にしか設定できない。\n* Cognitoは、電話番号、メールアドレス、ユーザー名の3つの属性をそれぞれユーザーの識別子として使うことができる。\n  * その場合、サインインに使える属性を「エイリアス」、「サインインエイリアス」、「エイリアス属性」そして「サインイン属性」などと呼ぶらしい？\n\n## サインイン属性のカスタマイズ\n\n* ユーザープールを作成する際に、`username`属性を構成することができる。\n  * ユーザープールを作成した後、この設定は変更できない。\n* Eメールアドレスや電話番号を `username`として使いたい、または、エイリアス属性を構成して、ユーザーに選択肢を提供することができる。\n* ユーザーは、サインアップ時に複数の属性を含めることができる。\n  * ユーザー名（`username`）\n  * 優先ユーザー名（`preferred_username`）\n  * Eメールアドレス（`email`）\n  * 電話番号（`phone_number`）\n* これらの属性を使って、サインインできるように構成できる。\n\n## エイリアス属性を使う場合にできること・やるべきこと\n\n* ユーザーは、複数のサインイン属性を持つことができる\n* ユーザーは、Eメールアドレスまたは電話番号でサインインする前に、その値を検証しなければならない\n* ユーザーのサインアップ時に、重複するEメールアドレスや電話番号を登録しても、`UsernameExistsException`が抑制される\n  * これは、サインアップがオープンになっている場合に、悪意のある第三者が、Eメールアドレスや電話番号が登録されているかどうかを調べることができなくなるということになる\n    * ただし、Eメールアドレスまたは電話番号の所有者が検証を実行するタイミングで、重複していることが確認できるとエラー（`AliasExistsException`）になるため、検証は成功しない\n* 複数のユーザーに、同じEメールアドレスや電話番号を登録することができる\n  * ただし、その属性を使ってサインインするためには、その属性の検証が成功している必要がある\n\n\n",
      "body_updated_at": "2024-01-23"
    },
    {
      "author": "muramasa64",
      "created_at": "2023-12-15",
      "body_markdown": "# 必須の属性と任意の属性\n\n* デフォルトでは、sub属性以外は任意であるが、必要に応じて必須とすることができる\n* ユーザープールを作成するときにしか設定できず、後で変更できないので注意が必要\n* 当然だが、必須にした属性はユーザー登録時に値が含まれていないといけない",
      "body_updated_at": "2023-12-15"
    },
    {
      "author": "muramasa64",
      "created_at": "2023-12-15",
      "body_markdown": "# 属性値の検証（Verify）\n\n* 電話番号とEメールアドレスは検証することができる。\n  * https://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/user-pool-settings-email-phone-verification.html\n* 電話番号は、SMSを使ってテキストメッセージを送ることで、ユーザーがその番号を所有していることを検証できる。その場合、Amazon SNSを使うので設定が必要になる。\n* Eメールアドレスは、メールを送ることでメールアドレスの受信可能性を検証できる。\n  * Eメールアドレスは、管理者が検証済みに変更することができる。\n* Eメールアドレスや電話番号でサインイン可能に設定する場合は、検証するべき",
      "body_updated_at": "2023-12-15"
    },
    {
      "author": "muramasa64",
      "created_at": "2023-12-15",
      "body_markdown": "# 複数の属性によるサインイン（エイリアス属性）\n\n* デフォルトではエイリアスは無効である\n  * ユーザーは、`username`と`password`を使ってサインインする\n  * この場合、`username`は変更することはできない\n* しかし、エイリアスを有効にすると、ユーザーは`username`以外の属性を使ってサインインすることができる\n\n## エイリアスを有効にするには\n\n* ユーザープールを作成する際に、ユーザー名と他の1つ以上の属性を選択する\n  * この設定は、ユーザープール作成時にのみ設定可能で、作成後に変更できない\n\n## preferred_username\n\n* `preferred_username`を有効にすると、ユーザーはサインインに使うユーザー名を変更できるようになる\n  * `username`は変更できないが、`preferred_username`は変更できる\n* `preferred_username`は、サインアップ時に設定することはできない\n\n## 注意点\n\n* エイリアスを有効にすると、有効にした属性に相当する値を、`username`属性に登録できなくなる。\n  * Eメールアドレスを有効にすると、有効な形式のメールアドレスを`username`に登録できなくなる\n  * 電話番号を有効にすると、有効な形式の電話番号を`username`に登録できなくなるできなくなる\n* エイリアス属性は、ユーザープールないで一意になる必要がある\n  * 登録はできるが、検証を完了することはできない\n* エイリアス属性を使う場合は、アプリケーションでのユーザーの認証や検索など、ユーザーを特定をする際に、エイリアス属性を使うのは避けること\n  * これらの値は変更可能であるため\n  * 変更できないユーザー識別子である`sub`を使うこと\n\n",
      "body_updated_at": "2023-12-15"
    },
    {
      "author": "muramasa64",
      "created_at": "2023-12-15",
      "body_markdown": "# username属性の値に、Eメールアドレスまたは電話番号を利用する\n\n`username`とは別の属性として存在するEメールアドレスや電話番号を使ってサインインできるようにすると、その属性はエイリアス属性となる。それとは別に、`username`属性の値として、Eメールアドレスや電話番号に相当する値を設定することもできる。「サインイン属性としてのEメールアドレスまたは電話番号」と呼ぶ。\n\n## 「サインイン属性としてのEメールアドレスまたは電話番号」を有効にするには\n\n* ユーザープールを作成する際に、サインインに使う属性として「ユーザー名」を選択せず、Eメールアドレスまたは電話番号のみ、あるいは、その両方を使うようにする。\n\n## エイリアス属性との違い\n\n* `username`に登録されるEメールアドレスまたは電話番号は、重複して登録できない\n* ユーザーはサインアップ時にEメールアドレスまたは電話番号をユーザー名として登録できる\n  * ユーザー名として登録したEメールアドレスを電話番号に変更することはできない。その逆も同様。\n* サインアップ時に、重複した値を登録しようとするとエラーになって登録できない\n* 登録したEメールアドレスまたは電話番号を検証する必要はない\n* `username`に登録されたEメールアドレスまたは電話番号は、自動的に`email`または`phone_number`属性に同じ値が入力される\n  * それぞれの属性値を必須にする必要はない"
    },
    {
      "author": "muramasa64",
      "created_at": "2023-12-16",
      "body_markdown": "# カスタム属性\n\n* カスタム属性は50個まで追加できる\n* カスタム属性をユーザープールに追加した後に、削除することはできない\n* ユーザープール作成後に追加することもできる\n* カスタム属性の名前は最大で20文字\n* カスタム属性の名前には、`custom:`プレフィックスが付与される\n* カスタム属性値の最小長または最大長を指定できる\n  * ただし、最大長は2048文字以下にする必要がある\n* 文字列または数値として定義できる\n  * ただし、CognitoはID Tokenの値は文字列として書き込む\n* カスタム属性は必須にできない\n* カスタム属性値は、ユーザーによる変更の可・不可を設定できる"
    },
    {
      "author": "muramasa64",
      "created_at": "2023-12-16",
      "body_markdown": "# 属性の権限とスコープ\n\nアプリケーションごとに、ユーザープールの各属性に対する書き込み・読み取りの権限を設定できる。これにより、管理ツールでは書き込み可能、エンドユーザーのアプリでは読み取りのみ、というような設定ができる。\n\n## アプリケーションの権限設定\n\nAWS Management Consoleで、登録されているアプリケーションクライアントのページに「属性の読み取りおよび書き込み許可」というセクションがあるので、そこで各属性ごとに設定を入れることができる。",
      "body_updated_at": "2023-12-16"
    }
  ]
}